{{if exists "/config/TraefikConfigVersion" }}
# This is configuration version {{ getv "/config/TraefikConfigVersion" }}
{{end}}

defaultEntryPoints = ["http","https"]
checkNewVersion = false

{{ $debug := ( getv "/config/Debug" "false" ) }}
{{ if ne $debug "false" }}
logLevel = "DEBUG"
acmeLogging = true
{{ else }}
logLevel = "INFO"
acmeLogging = false
{{ end }}

MaxIdleConnsPerHost = 1000

[traefiklog]
  filepath = "/var/log/traefik_error.log"
  format   = "json"

[accessLog]
  filePath = "/var/log/traefik.log"
  format = "json"

[entryPoints]
  [entryPoints.traefik]
    address = ":9109"
  [entryPoints.http]
    address = ":80"
     [entryPoints.http.redirect]
       entryPoint = "https"
  [entryPoints.https]
    address = ":443"
    [entryPoints.https.tls]
    MinVersion = "VersionTLS12"

[ping]
[api]
  [api.statistics]
[metrics]
  [metrics.prometheus]

[consul]
endpoint = "127.0.0.1:8500"
watch = true
prefix = "{{ getv "/config/ServiceName" }}/{{ getv "/config/EnvironmentName" }}/config"

# Use HTTP-01 challenges
[acme.httpChallenge]
  entryPoint = "http"

[acme]
# Handle when this isn't set
email="{{ getv "/config/Email/Destination" }}"
storage = "{{ getv "/config/ServiceName" }}/{{ getv "/config/EnvironmentName" }}/acme"
entryPoint = "https"

# Doesn't fallback to https:// checks, bummer
#dnsProvider = "route53"

# Only set CA server in stage where this consul key exists
{{if exists "/config/LetsEncrypt/CAServer" }}
caServer = "{{ getv "/config/LetsEncrypt/CAServer" }}"
{{end}}

acmeLogging = true
onDemand = false
onHostRule = false

[file]

[backends]
  [backends.backend1]
    [backends.backend1.servers.server1]
    # Send to Varnish
    url = "http://127.0.0.1:82"

[frontends]
  [frontends.frontend1]
  backend = "backend1"
  passHostHeader = true
  entryPoints = [ "http", "https" ]

# Static Sites
{{ $env:=getv "/config/EnvironmentName" }}
{{ if eq $env "prod" }}

[[acme.domains]]
main = "dynamicua-origin.cdn.mozilla.net"

[[acme.domains]]
main = "www.mozqa.com"
sans = [
  "mozqa.com"
]

[[acme.domains]]
main = "www.getfirebug.com"
sans = [
  "getfirebug.com"
]

[[acme.domains]]
main = "www.ccadb.org"
sans = [
  "ccadb.org"
]

[[acme.domains]]
main = "iot.mozilla.org"

[[acme.domains]]
main = "design.firefox.com"

[[acme.domains]]
main = "tlscanary.mozilla.org"
sans = [
  "tlscanary-haul.mozilla.org"
]

[[acme.domains]]
main = "static.mozilla.com"
sans = [
  "static-haul.mozilla.com"
]

[[acme.domains]]
main = "website-archive.mozilla.org"
sans = [
  "website-archive-haul.mozilla.org"
]

[[acme.domains]]
main = "www-archive.mozilla.org"
sans = [
  "www-archive-haul.mozilla.org"
]

[[acme.domains]]
main = "planet.mozilla.org"
sans = [
  "planet-haul.mozilla.org"
]

[[acme.domains]]
main = "krakenbenchmark.mozilla.org"

[[acme.domains]]
main = "www.mozilla.net"
sans = [
  "apps.mozillalabs.com",
  "events.mozspaces.org",
  "arewefunyet.com",
  "arewestableyet.com",
  "boot2gecko.org",
  "contributejson.org",
  "detodosparatodos.com"
]

[[acme.domains]]
main = "planet.mozilla.de"

{{ else }}

[[acme.domains]]
main = "dynamicua.allizom.org"

[[acme.domains]]
main = "mozqa.allizom.org"

[[acme.domains]]
main = "getfirebug.allizom.org"

[[acme.domains]]
main = "ccadb.allizom.org"

[[acme.domains]]
main = "iot.allizom.org"

[[acme.domains]]
main = "design.allizom.org"

[[acme.domains]]
main = "tlscanary.allizom.org"
sans = [
  "tlscanary-haul.allizom.org"
]

[[acme.domains]]
main = "static.allizom.org"
sans = [
  "static-haul.allizom.org"
]

[[acme.domains]]
main = "website-archive.allizom.org"
sans = [
  "website-archive-haul.allizom.org"
]

[[acme.domains]]
main = "www-archive.allizom.org"
sans = [
  "www-archive-haul.allizom.org"
]

[[acme.domains]]
main = "bugzilla-haul.allizom.org"

[[acme.domains]]
main = "itisatracker-haul.allizom.org"

[[acme.domains]]
main = "nightly-haul.allizom.org"

[[acme.domains]]
main = "planet.allizom.org"
sans = [
  "planet-haul.allizom.org"
]

[[acme.domains]]
main = "planet-bugzilla.allizom.org"

[[acme.domains]]
main = "planet.bugzilla.org"

[[acme.domains]]
main = "publicsuffix-haul.allizom.org"

[[acme.domains]]
main = "seamonkey-project-haul.allizom.org"

[[acme.domains]]
main = "start-haul.allizom.org"

[[acme.domains]]
main = "krakenbenchmark.allizom.org"

[[acme.domains]]
main = "redirecttest.allizom.org"
sans = [
  "prs.paas.allizom.org",
]

[[acme.domains]]
main = "planet-de.allizom.org"

{{ end }}
